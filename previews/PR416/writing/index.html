<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Writing Videos · VideoIO.jl</title><meta name="title" content="Writing Videos · VideoIO.jl"/><meta property="og:title" content="Writing Videos · VideoIO.jl"/><meta property="twitter:title" content="Writing Videos · VideoIO.jl"/><meta name="description" content="Documentation for VideoIO.jl."/><meta property="og:description" content="Documentation for VideoIO.jl."/><meta property="twitter:description" content="Documentation for VideoIO.jl."/><meta property="og:url" content="https://juliaio.github.io/VideoIO.jl/stable/writing/"/><meta property="twitter:url" content="https://juliaio.github.io/VideoIO.jl/stable/writing/"/><link rel="canonical" href="https://juliaio.github.io/VideoIO.jl/stable/writing/"/><script async src="https://www.googletagmanager.com/gtag/js?id=UA-143027902-2"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-143027902-2', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="VideoIO.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">VideoIO.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Introduction</a></li><li><a class="tocitem" href="../reading/">Reading Videos</a></li><li class="is-active"><a class="tocitem" href>Writing Videos</a><ul class="internal"><li><a class="tocitem" href="#Single-step-Encoding"><span>Single-step Encoding</span></a></li><li><a class="tocitem" href="#Iterative-Encoding"><span>Iterative Encoding</span></a></li><li><a class="tocitem" href="#Supported-Colortypes"><span>Supported Colortypes</span></a></li><li><a class="tocitem" href="#Encoder-Options"><span>Encoder Options</span></a></li><li><a class="tocitem" href="#Lossless-Encoding"><span>Lossless Encoding</span></a></li></ul></li><li><a class="tocitem" href="../utilities/">Utilities</a></li><li><a class="tocitem" href="../lowlevel/">Low Level Functionality</a></li><li><a class="tocitem" href="../functionindex/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Writing Videos</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Writing Videos</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaIO/VideoIO.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaIO/VideoIO.jl/blob/master/docs/src/writing.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Writing-Videos"><a class="docs-heading-anchor" href="#Writing-Videos">Writing Videos</a><a id="Writing-Videos-1"></a><a class="docs-heading-anchor-permalink" href="#Writing-Videos" title="Permalink"></a></h1><p>Note: Writing of audio streams is not yet implemented</p><h2 id="Single-step-Encoding"><a class="docs-heading-anchor" href="#Single-step-Encoding">Single-step Encoding</a><a id="Single-step-Encoding-1"></a><a class="docs-heading-anchor-permalink" href="#Single-step-Encoding" title="Permalink"></a></h2><p>Videos can be encoded directly from image stack using <code>VideoIO.save(filename::String, imgstack::Array)</code> where <code>imgstack</code> is an array of image arrays with identical type and size.</p><p>The entire image stack can be encoded in a single step:</p><pre><code class="language-julia hljs">import VideoIO
encoder_options = (crf=23, preset=&quot;medium&quot;)
VideoIO.save(&quot;video.mp4&quot;, imgstack, framerate=30, encoder_options=encoder_options)</code></pre><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="VideoIO.save" href="#VideoIO.save"><code>VideoIO.save</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">save(filename::String, imgstack; ...)</code></pre><p>Create a video container <code>filename</code> and encode the set of frames <code>imgstack</code> into it. <code>imgstack</code> must be an iterable of matrices and each frame must have the same dimensions and element type.</p><p>Encoding options, restrictions on frame size and element type, and other details are described in <a href="#VideoIO.open_video_out"><code>open_video_out</code></a>. All keyword arguments are passed to <code>open_video_out</code>.</p><p>See also: <a href="#VideoIO.open_video_out"><code>open_video_out</code></a>, <a href="#Base.write-Tuple{VideoIO.VideoWriter, Any, Int64}"><code>write</code></a>, <a href="#VideoIO.close_video_out!"><code>close_video_out!</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIO/VideoIO.jl/blob/946516a5509fc18842f5c57eb1bfd03fa8057bd7/src/encoding.jl#L486-L499">source</a></section></article><h2 id="Iterative-Encoding"><a class="docs-heading-anchor" href="#Iterative-Encoding">Iterative Encoding</a><a id="Iterative-Encoding-1"></a><a class="docs-heading-anchor-permalink" href="#Iterative-Encoding" title="Permalink"></a></h2><p>Alternatively, videos can be encoded iteratively within custom loops.</p><pre><code class="language-julia hljs">using VideoIO
framestack = map(x-&gt;rand(UInt8, 100, 100), 1:100) #vector of 2D arrays

encoder_options = (crf=23, preset=&quot;medium&quot;)
framerate=24
open_video_out(&quot;video.mp4&quot;, framestack[1], framerate=framerate, encoder_options=encoder_options) do writer
    for frame in framestack
        write(writer, frame)
    end
end</code></pre><p>An example saving a series of png files as a video:</p><pre><code class="language-julia hljs">using VideoIO, ProgressMeter

dir = &quot;&quot; #path to directory holding images
imgnames = filter(x-&gt;occursin(&quot;.png&quot;,x), readdir(dir)) # Populate list of all .pngs
intstrings =  map(x-&gt;split(x,&quot;.&quot;)[1], imgnames) # Extract index from filenames
p = sortperm(parse.(Int, intstrings)) #sort files numerically
imgnames = imgnames[p]

encoder_options = (crf=23, preset=&quot;medium&quot;)

firstimg = load(joinpath(dir, imgnames[1]))
open_video_out(&quot;video.mp4&quot;, firstimg, framerate=24, encoder_options=encoder_options) do writer
    @showprogress &quot;Encoding video frames..&quot; for i in eachindex(imgnames)
        img = load(joinpath(dir, imgnames[i]))
        write(writer, img)
    end
end</code></pre><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="VideoIO.open_video_out" href="#VideoIO.open_video_out"><code>VideoIO.open_video_out</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">open_video_out(filename, ::Type{T}, sz::NTuple{2, Integer};
               &lt;keyword arguments&gt;) -&gt; writer
open_video_out(filename, first_img::Matrix; ...)
open_video_out(f, ...; ...)</code></pre><p>Open file <code>filename</code> and prepare to encode a video stream into it, returning object <code>writer</code> that can be used to encode frames. The size and element type of the video can either be specified by passing the first frame of the movie <code>first_img</code>, which will not be encoded, or instead the element type <code>T</code> and 2-tuple size <code>sz</code>. If the size is explicitly specified, the first element will be the height, and the second width, unless keyword argument <code>scanline_major = true</code>, in which case the order is reversed. Both height and width must be even. The element type <code>T</code> must be one of the supported element types, which is any key of <code>VideoIO.VIO_DEF_ELTYPE_PIX_FMT_LU</code>, or instead the <code>Normed</code> or <code>Unsigned</code> type for a corresponding <code>Gray</code> element type. The container type will be inferred from <code>filename</code>.</p><p>Frames are encoded with <a href="#Base.write-Tuple{VideoIO.VideoWriter, Any, Int64}"><code>write</code></a>, which must use frames with the same size, element type, and obey the same value of <code>scanline_major</code>. The video must be closed once all frames are encoded with <a href="#VideoIO.close_video_out!"><code>close_video_out!</code></a>.</p><p>If called with a function as the first argument, <code>f</code>, then the function will be called with the writer object <code>writer</code> as its only argument. This <code>writer</code> object will be closed once the call is complete, regardless of whether or not an error occurred.</p><p><strong>Keyword arguments</strong></p><ul><li><code>codec_name::Union{AbstractString, Nothing} = nothing</code>: Name of the codec to use. Must be a name accepted by <a href="https://ffmpeg.org/">FFmpeg</a>, and compatible with the chosen container type, or <code>nothing</code>, in which case the codec will be automatically selected by FFmpeg based on the container.</li><li><code>framerate::Real = 24</code>: Framerate of the resulting video.</li><li><code>scanline_major::Bool = false</code>: If <code>false</code>, then Julia arrays are assumed to have frame height in the first dimension, and frame width on the second. If <code>true</code>, then pixels that adjacent to eachother in the same scanline (i.e. horizontal line of the video) are assumed to be adjacent to eachother in memory. <code>scanline_major = true</code> videos must be <code>StridedArray</code>s with unit stride in the first dimension. For normal arrays, this corresponds to a matrix where frame width is in the first dimension, and frame height is in the second.</li><li><code>container_options::OptionsT = (;)</code>: A <code>NamedTuple</code> or <code>Dict{Symbol, Any}</code> of options for the container. Must correspond to option names and values accepted by <a href="https://ffmpeg.org/">FFmpeg</a>.</li><li><code>container_private_options::OptionsT = (;)</code>: A <code>NamedTuple</code> or <code>Dict{Symbol, Any}</code> of private options for the container. Must correspond to private options names and values accepted by <a href="https://ffmpeg.org/">FFmpeg</a> for the chosen container type.</li><li><code>encoder_options::OptionsT = (;)</code>: A <code>NamedTuple</code> or <code>Dict{Symbol, Any}</code> of options for the encoder context. Must correspond to option names and values accepted by <a href="https://ffmpeg.org/">FFmpeg</a>.</li><li><code>encoder_private_options::OptionsT = (;)</code>: A <code>NamedTuple</code> or <code>Dict{Symbol, Any}</code> of private options for the encoder context. Must correspond to private option names and values accepted by <a href="https://ffmpeg.org/">FFmpeg</a> for the chosen codec specified by <code>codec_name</code>.</li><li><code>swscale_options::OptionsT = (;)</code>: A <code>Namedtuple</code>, or <code>Dict{Symbol, Any}</code> of options for the swscale object used to perform color space scaling. Options must correspond with options for FFmpeg&#39;s <a href="https://ffmpeg.org/ffmpeg-all.html#Scaler-Options">scaler</a> filter.</li><li><code>target_pix_fmt::Union{Nothing, Cint} = nothing</code>: The pixel format that will be used to input data into the encoder. This can either by a <code>VideoIO.AV_PIX_FMT_*</code> value corresponding to a FFmpeg <a href="https://ffmpeg.org/doxygen/4.1/pixfmt_8h.html#a9a8e335cf3be472042bc9f0cf80cd4c5"><code>AVPixelFormat</code></a>, and must then be a format supported by the encoder, or instead <code>nothing</code>, in which case it will be chosen automatically by FFmpeg.</li><li><code>pix_fmt_loss_flags = 0</code>: Loss flags to control how encoding pixel format is chosen. Only valid if <code>target_pix_fmt = nothing</code>. Flags must correspond to FFmpeg <a href="http://ffmpeg.org/doxygen/2.5/pixdesc_8h.html#a445e6541dde2408332c216b8d0accb2d">loss flags</a>.</li><li><code>input_colorspace_details = nothing</code>: Information about the color space of input Julia arrays. If <code>nothing</code>, then this will correspond to a best-effort interpretation of <code>Colors.jl</code> for the corresponding element type. To override these defaults, create a <code>VideoIO.VioColorspaceDetails</code> object using the appropriate <code>AVCOL_</code> definitions from FFmpeg, or use <code>VideoIO.VioColorspaceDetails()</code> to use the FFmpeg defaults. If data in the input Julia arrays is already in the mpeg color range, then set this to <code>VideoIO.VioColorspaceDetails()</code> to avoid additional scaling by <code>sws_scale</code>.</li><li><code>allow_vio_gray_transform = true</code>: Instead of using <code>sws_scale</code> for gray data, use a more accurate color space transformation implemented in <code>VideoIO</code> if <code>allow_vio_gray_transform = true</code>. Otherwise, use <code>sws_scale</code>.</li><li><code>sws_color_options::OptionsT = (;)</code>: Additional keyword arguments passed to <a href="http://ffmpeg.org/doxygen/2.5/group__libsws.html#ga541bdffa8149f5f9203664f955faa040">sws_setColorspaceDetails</a>.</li><li><code>thread_count::Union{Nothing, Int} = nothing</code>: The number of threads the codec is allowed to use, or <code>nothing</code> for default codec behavior. Defaults to <code>nothing</code>.</li></ul><p>See also: <a href="#Base.write-Tuple{VideoIO.VideoWriter, Any, Int64}"><code>write</code></a>, <a href="#VideoIO.close_video_out!"><code>close_video_out!</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIO/VideoIO.jl/blob/946516a5509fc18842f5c57eb1bfd03fa8057bd7/src/encoding.jl#L382-L472">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Base.write-Tuple{VideoIO.VideoWriter, Any, Int64}" href="#Base.write-Tuple{VideoIO.VideoWriter, Any, Int64}"><code>Base.write</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">write(writer::VideoWriter, img)
write(writer::VideoWriter, img, index)</code></pre><p>Prepare frame <code>img</code> for encoding, encode it, mux it, and either cache it or write it to the file described by <code>writer</code>. <code>img</code> must be the same size and element type as the size and element type that was used to create <code>writer</code>. If <code>index</code> is provided, it must start at zero and increment monotonically.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIO/VideoIO.jl/blob/946516a5509fc18842f5c57eb1bfd03fa8057bd7/src/encoding.jl#L77-L85">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="VideoIO.close_video_out!" href="#VideoIO.close_video_out!"><code>VideoIO.close_video_out!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">close_video_out!(writer::VideoWriter)</code></pre><p>Write all frames cached in <code>writer</code> to the video container that it describes, and then close the file. Once all frames in a video have been added to <code>writer</code>, then it must be closed with this function to flush any cached frames to the file, and then finally close the file and release resources associated with <code>writer</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIO/VideoIO.jl/blob/946516a5509fc18842f5c57eb1bfd03fa8057bd7/src/encoding.jl#L94-L101">source</a></section></article><h2 id="Supported-Colortypes"><a class="docs-heading-anchor" href="#Supported-Colortypes">Supported Colortypes</a><a id="Supported-Colortypes-1"></a><a class="docs-heading-anchor-permalink" href="#Supported-Colortypes" title="Permalink"></a></h2><p>Encoding of the following image element color types currently supported:</p><ul><li><code>UInt8</code></li><li><code>Gray{N0f8}</code></li><li><code>RGB{N0f8}</code></li></ul><h2 id="Encoder-Options"><a class="docs-heading-anchor" href="#Encoder-Options">Encoder Options</a><a id="Encoder-Options-1"></a><a class="docs-heading-anchor-permalink" href="#Encoder-Options" title="Permalink"></a></h2><p>The <code>encoder_options</code> keyword argument allows control over FFmpeg encoding options. Optional fields can be found <a href="https://ffmpeg.org/ffmpeg-codecs.html#Codec-Options">here</a>.</p><p>More details about options specific to h264 can be found <a href="https://trac.ffmpeg.org/wiki/Encode/H.264">here</a>.</p><p>Some example values for the <code>encoder_options</code> keyword argument are:</p><table><tr><th style="text-align: center">Goal</th><th style="text-align: left"><code>encoder_options</code> value</th></tr><tr><td style="text-align: center">Perceptual compression, h264 default. Best for most cases</td><td style="text-align: left"><code>(crf=23, preset=&quot;medium&quot;)</code></td></tr><tr><td style="text-align: center">Lossless compression. Fastest, largest file size</td><td style="text-align: left"><code>(crf=0, preset=&quot;ultrafast&quot;)</code></td></tr><tr><td style="text-align: center">Lossless compression. Slowest, smallest file size</td><td style="text-align: left"><code>(crf=0, preset=&quot;veryslow&quot;)</code></td></tr><tr><td style="text-align: center">Direct control of bitrate and frequency of intra frames (every 10)</td><td style="text-align: left"><code>(bit_rate = 400000, gop_size = 10, max_b_frames = 1)</code></td></tr></table><p>If a hyphenated parameter is needed, it can be added using <code>var&quot;param-name&quot; = value</code>.</p><h2 id="Lossless-Encoding"><a class="docs-heading-anchor" href="#Lossless-Encoding">Lossless Encoding</a><a id="Lossless-Encoding-1"></a><a class="docs-heading-anchor-permalink" href="#Lossless-Encoding" title="Permalink"></a></h2><h3 id="Lossless-RGB"><a class="docs-heading-anchor" href="#Lossless-RGB">Lossless RGB</a><a id="Lossless-RGB-1"></a><a class="docs-heading-anchor-permalink" href="#Lossless-RGB" title="Permalink"></a></h3><p>If lossless encoding of <code>RGB{N0f8}</code> is required, <em>true</em> lossless requires passing <code>codec_name = &quot;libx264rgb&quot;</code> to the function to avoid the lossy RGB-&gt;YUV420 conversion, as well as adding <code>crf=0</code> in <code>encoder_options</code>.</p><h3 id="Lossless-Grayscale"><a class="docs-heading-anchor" href="#Lossless-Grayscale">Lossless Grayscale</a><a id="Lossless-Grayscale-1"></a><a class="docs-heading-anchor-permalink" href="#Lossless-Grayscale" title="Permalink"></a></h3><p>If lossless encoding of <code>Gray{N0f8}</code> or <code>UInt8</code> is required, <code>crf=0</code> should be set, as well as <code>color_range=2</code> to ensure full 8-bit pixel color representation. i.e. <code>(color_range=2, crf=0, preset=&quot;medium&quot;)</code></p><h3 id="Encoding-Performance"><a class="docs-heading-anchor" href="#Encoding-Performance">Encoding Performance</a><a id="Encoding-Performance-1"></a><a class="docs-heading-anchor-permalink" href="#Encoding-Performance" title="Permalink"></a></h3><p>See <a href="https://github.com/JuliaIO/VideoIO.jl/blob/master/util/lossless_video_encoding_testing.jl"><code>util/lossless_video_encoding_testing.jl</code></a> for testing of losslessness, speed, and compression as a function of h264 encoding preset, for 3 example videos.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../reading/">« Reading Videos</a><a class="docs-footer-nextpage" href="../utilities/">Utilities »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Wednesday 14 February 2024 19:37">Wednesday 14 February 2024</span>. Using Julia version 1.10.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
